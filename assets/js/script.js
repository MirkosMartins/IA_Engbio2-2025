/**
 * Script Principal da Aplica√ß√£o
 * ML Cancer Detection - Aplica√ß√£o Interativa
 */

// Inst√¢ncias globais dos gerenciadores
let uiManager;
let apiManager;
let chartsManager;

/**
 * Inicializa√ß√£o da aplica√ß√£o
 */
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Inicializando ML Cancer Detection App...');
    
    // Verificar depend√™ncias
    if (typeof Chart === 'undefined') {
        console.warn('‚ö†Ô∏è Chart.js n√£o carregado - gr√°ficos podem n√£o funcionar');
    }
    
    if (typeof d3 === 'undefined') {
        console.warn('‚ö†Ô∏è D3.js n√£o carregado - visualiza√ß√£o da √°rvore pode n√£o funcionar');
    }

    // Inicializar gerenciadores
    initializeManagers();
    
    // Configurar event listeners globais
    setupGlobalEventListeners();
    
    // Configurar formul√°rio
    setupFormEnhancements();
    
    // Inicializar tooltips e ajuda
    initializeHelpSystem();
    
    // Configurar tema
    initializeTheme();
    
    console.log('‚úÖ Aplica√ß√£o inicializada com sucesso!');
});

/**
 * Inicializar gerenciadores
 */
function initializeManagers() {
    try {
        // UI Manager
        uiManager = new UIManager();
        console.log('‚úÖ UI Manager inicializado');
        
        // API Manager
        apiManager = new APIManager();
        console.log('‚úÖ API Manager inicializado');
        
        // Charts Manager
        chartsManager = new ChartsManager();
        console.log('‚úÖ Charts Manager inicializado');
        
        // Conectar gerenciadores
        connectManagers();
        
    } catch (error) {
        console.error('‚ùå Erro ao inicializar gerenciadores:', error);
        showErrorMessage('Erro ao inicializar aplica√ß√£o. Recarregue a p√°gina.');
    }
}

/**
 * Conectar gerenciadores
 */
function connectManagers() {
    // Sobrescrever m√©todo de processamento do modelo no UI Manager
    if (uiManager) {
        uiManager.processModel = async function(formData) {
            try {
                // Mostrar se√ß√£o de treinamento
                this.showSection('training');
                this.updateActiveNavLink(document.querySelector('a[href="#training"]'));
                
                // Resetar API Manager
                apiManager.reset();
                
                // Processar pipeline completo
                const results = await apiManager.processFullPipeline(formData);
                
                if (apiManager.isCancelled()) {
                    throw new Error('Opera√ß√£o cancelada');
                }
                
                // Gerar visualiza√ß√µes
                const visualizations = await apiManager.generateVisualizations(results);
                
                // Atualizar UI com resultados
                updateUIWithResults(results, visualizations);
                
                // Mostrar se√ß√£o de resultados
                this.showSection('results');
                this.updateActiveNavLink(document.querySelector('a[href="#results"]'));
                
                // Atualizar gr√°ficos
                updateCharts(visualizations);
                
            } catch (error) {
                console.error('Erro no processamento:', error);
                this.addLog(`Erro: ${error.message}`, 'error');
                throw error;
            }
        };
    }
    
    // Conectar logs da API com UI
    window.addEventListener('apiLog', function(event) {
        if (uiManager && uiManager.addLog) {
            uiManager.addLog(event.detail.message, event.detail.type);
        }
    });
}

/**
 * Atualizar UI com resultados
 */
function updateUIWithResults(results, visualizations) {
    // Atualizar m√©tricas
    updateMetricsDisplay(results.results.metrics);
    
    // Atualizar estat√≠sticas do dataset
    updateDatasetStats(results.dataset);
    
    // Mostrar se√ß√£o do dataset se ainda n√£o foi mostrada
    const datasetSection = document.getElementById('dataset');
    if (datasetSection) {
        datasetSection.style.display = 'block';
    }
}

/**
 * Atualizar exibi√ß√£o das m√©tricas
 */
function updateMetricsDisplay(metrics) {
    const metricElements = {
        'accuracyValue': metrics.accuracy + '%',
        'precisionValue': metrics.precision + '%',
        'recallValue': metrics.recall + '%',
        'f1Value': metrics.f1Score + '%',
        'sensitivityValue': metrics.sensitivity + '%',
        'specificityValue': metrics.specificity + '%',
        'ppvValue': metrics.ppv + '%',
        'npvValue': metrics.npv + '%'
    };
    
    Object.entries(metricElements).forEach(([id, value]) => {
        const element = document.getElementById(id);
        if (element && uiManager) {
            uiManager.animateCounter(element, value);
        }
    });
}

/**
 * Atualizar estat√≠sticas do dataset
 */
function updateDatasetStats(dataset) {
    const stats = {
        'totalSamples': dataset.samples.toString(),
        'totalFeatures': dataset.features.toString(),
        'benignSamples': dataset.classes.benign ? dataset.classes.benign.toString() : '0',
        'malignantSamples': dataset.classes.malignant ? dataset.classes.malignant.toString() : '0'
    };
    
    Object.entries(stats).forEach(([id, value]) => {
        const element = document.getElementById(id);
        if (element && uiManager) {
            uiManager.animateCounter(element, value);
        }
    });
}

/**
 * Atualizar gr√°ficos
 */
function updateCharts(visualizations) {
    if (!chartsManager) return;
    
    try {
        // Atualizar distribui√ß√£o de classes
        if (visualizations.classDistribution) {
            const benign = visualizations.classDistribution.benign || 0;
            const malignant = visualizations.classDistribution.malignant || 0;
            chartsManager.updateClassDistribution(benign, malignant);
        }
        
        // Atualizar matriz de confus√£o
        if (visualizations.confusionMatrix) {
            chartsManager.updateConfusionMatrix(visualizations.confusionMatrix);
        }
        
        // Atualizar import√¢ncia das features
        if (visualizations.featureImportance) {
            chartsManager.updateFeatureImportance(
                visualizations.featureImportance.features,
                visualizations.featureImportance.importance
            );
        }
        
        // Atualizar curva ROC
        if (visualizations.rocCurve) {
            chartsManager.updateROCCurve(visualizations.rocCurve, 0.94);
        }
        
        // Criar visualiza√ß√£o da √°rvore
        if (visualizations.decisionTree) {
            chartsManager.createDecisionTreeVisualization();
        }
        
        // Mostrar se√ß√£o de visualiza√ß√µes
        const vizSection = document.getElementById('visualizations');
        if (vizSection) {
            vizSection.style.display = 'block';
        }
        
    } catch (error) {
        console.error('Erro ao atualizar gr√°ficos:', error);
    }
}

/**
 * Configurar event listeners globais
 */
function setupGlobalEventListeners() {
    // Redimensionamento da janela
    window.addEventListener('resize', debounce(function() {
        if (chartsManager) {
            chartsManager.resizeCharts();
        }
    }, 250));
    
    // Navega√ß√£o por teclado
    document.addEventListener('keydown', function(e) {
        // ESC para cancelar opera√ß√µes
        if (e.key === 'Escape') {
            if (apiManager) {
                apiManager.cancel();
            }
        }
        
        // F5 para recarregar dados
        if (e.key === 'F5' && e.ctrlKey) {
            e.preventDefault();
            if (uiManager) {
                uiManager.loadPresetData();
            }
        }
    });
    
    // Scroll spy para navega√ß√£o
    setupScrollSpy();
}

/**
 * Configurar scroll spy
 */
function setupScrollSpy() {
    const sections = document.querySelectorAll('.section[id]');
    const navLinks = document.querySelectorAll('.nav-link');
    
    function updateActiveLink() {
        let currentSection = '';
        
        sections.forEach(section => {
            const sectionTop = section.offsetTop - 100;
            const sectionHeight = section.offsetHeight;
            
            if (window.scrollY >= sectionTop && window.scrollY < sectionTop + sectionHeight) {
                currentSection = section.getAttribute('id');
            }
        });
        
        navLinks.forEach(link => {
            link.classList.remove('active');
            if (link.getAttribute('href') === `#${currentSection}`) {
                link.classList.add('active');
            }
        });
    }
    
    window.addEventListener('scroll', throttle(updateActiveLink, 100));
}

/**
 * Configurar melhorias do formul√°rio
 */
function setupFormEnhancements() {
    // Valida√ß√£o em tempo real
    const inputs = document.querySelectorAll('input, select');
    inputs.forEach(input => {
        input.addEventListener('blur', validateField);
        input.addEventListener('input', clearValidationErrors);
    });
    
    // Auto-save do formul√°rio
    setupFormAutoSave();
    
    // Atalhos de teclado
    setupKeyboardShortcuts();
}

/**
 * Validar campo individual
 */
function validateField(event) {
    const field = event.target;
    const value = field.value.trim();
    
    // Remover valida√ß√µes anteriores
    field.classList.remove('error', 'success');
    clearFieldErrors(field);
    
    // Validar baseado no tipo
    switch (field.id) {
        case 'datasetUrl':
            validateDatasetUrlField(field, value);
            break;
        case 'trainSize':
            validateTrainSizeField(field, value);
            break;
        case 'minSamplesSplit':
        case 'minSamplesLeaf':
            validateNumericField(field, value);
            break;
    }
}

/**
 * Validar campo URL do dataset
 */
function validateDatasetUrlField(field, value) {
    if (!value) return; // Campo opcional inicialmente
    
    const isUCIId = /^\d+$/.test(value);
    const isValidUrl = isValidURL(value);
    
    if (!isUCIId && !isValidUrl) {
        showFieldError(field, 'Digite um ID do UCI (ex: 17) ou uma URL v√°lida');
    } else {
        field.classList.add('success');
    }
}

/**
 * Validar campo de tamanho do treino
 */
function validateTrainSizeField(field, value) {
    const num = parseInt(value);
    if (num < 60 || num > 90) {
        showFieldError(field, 'Valor deve estar entre 60% e 90%');
    } else {
        field.classList.add('success');
    }
}

/**
 * Validar campo num√©rico
 */
function validateNumericField(field, value) {
    const num = parseInt(value);
    if (isNaN(num) || num < 1) {
        showFieldError(field, 'Digite um n√∫mero v√°lido maior que 0');
    } else {
        field.classList.add('success');
    }
}

/**
 * Limpar erros de valida√ß√£o
 */
function clearValidationErrors(event) {
    const field = event.target;
    if (field.classList.contains('error')) {
        field.classList.remove('error');
        clearFieldErrors(field);
    }
}

/**
 * Mostrar erro no campo
 */
function showFieldError(field, message) {
    field.classList.add('error');
    
    const errorDiv = document.createElement('div');
    errorDiv.className = 'form-error';
    errorDiv.textContent = message;
    field.parentNode.appendChild(errorDiv);
}

/**
 * Limpar erros do campo
 */
function clearFieldErrors(field) {
    const errors = field.parentNode.querySelectorAll('.form-error');
    errors.forEach(error => error.remove());
}

/**
 * Configurar auto-save do formul√°rio
 */
function setupFormAutoSave() {
    const form = document.getElementById('configForm');
    if (!form) return;
    
    const inputs = form.querySelectorAll('input, select');
    
    inputs.forEach(input => {
        input.addEventListener('change', saveFormData);
    });
    
    // Carregar dados salvos
    loadFormData();
}

/**
 * Salvar dados do formul√°rio
 */
function saveFormData() {
    const formData = {};
    const form = document.getElementById('configForm');
    
    if (form) {
        const formDataObj = new FormData(form);
        for (let [key, value] of formDataObj.entries()) {
            formData[key] = value;
        }
        
        localStorage.setItem('mlCancerDetection_formData', JSON.stringify(formData));
    }
}

/**
 * Carregar dados do formul√°rio
 */
function loadFormData() {
    try {
        const savedData = localStorage.getItem('mlCancerDetection_formData');
        if (savedData) {
            const formData = JSON.parse(savedData);
            
            Object.entries(formData).forEach(([key, value]) => {
                const field = document.getElementById(key);
                if (field) {
                    field.value = value;
                    
                    // Disparar evento de mudan√ßa
                    field.dispatchEvent(new Event('change', { bubbles: true }));
                }
            });
        }
    } catch (error) {
        console.warn('Erro ao carregar dados salvos:', error);
    }
}

/**
 * Configurar atalhos de teclado
 */
function setupKeyboardShortcuts() {
    document.addEventListener('keydown', function(e) {
        // Ctrl + Enter para treinar modelo
        if (e.ctrlKey && e.key === 'Enter') {
            e.preventDefault();
            const trainBtn = document.getElementById('trainModelBtn');
            if (trainBtn && !trainBtn.disabled) {
                trainBtn.click();
            }
        }
        
        // Ctrl + L para carregar exemplo
        if (e.ctrlKey && e.key === 'l') {
            e.preventDefault();
            const presetBtn = document.getElementById('loadPresetBtn');
            if (presetBtn) {
                presetBtn.click();
            }
        }
    });
}

/**
 * Inicializar sistema de ajuda
 */
function initializeHelpSystem() {
    // Tooltips para campos do formul√°rio
    const tooltips = {
        'datasetUrl': 'Digite um ID do UCI ML Repository (ex: 17) ou URL de um arquivo CSV',
        'trainSize': 'Percentual dos dados usado para treinar o modelo',
        'maxDepth': 'Profundidade m√°xima da √°rvore de decis√£o',
        'criterion': 'Fun√ß√£o usada para medir a qualidade das divis√µes',
        'minSamplesSplit': 'N√∫mero m√≠nimo de amostras necess√°rias para dividir um n√≥',
        'minSamplesLeaf': 'N√∫mero m√≠nimo de amostras necess√°rias em um n√≥ folha'
    };
    
    Object.entries(tooltips).forEach(([id, text]) => {
        const element = document.getElementById(id);
        if (element) {
            element.setAttribute('title', text);
        }
    });
}

/**
 * Inicializar tema
 */
function initializeTheme() {
    // Detectar prefer√™ncia de tema do sistema
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    
    // Aplicar tema salvo ou padr√£o
    const savedTheme = localStorage.getItem('mlCancerDetection_theme') || (prefersDark ? 'dark' : 'light');
    applyTheme(savedTheme);
}

/**
 * Aplicar tema
 */
function applyTheme(theme) {
    document.body.setAttribute('data-theme', theme);
    localStorage.setItem('mlCancerDetection_theme', theme);
}

/**
 * Mostrar mensagem de erro
 */
function showErrorMessage(message) {
    if (uiManager && uiManager.showToast) {
        uiManager.showToast(message, 'error');
    } else {
        alert(message);
    }
}

/**
 * Verificar se √© URL v√°lida
 */
function isValidURL(string) {
    try {
        new URL(string);
        return true;
    } catch (_) {
        return false;
    }
}

/**
 * Debounce function
 */
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

/**
 * Throttle function
 */
function throttle(func, limit) {
    let inThrottle;
    return function() {
        const args = arguments;
        const context = this;
        if (!inThrottle) {
            func.apply(context, args);
            inThrottle = true;
            setTimeout(() => inThrottle = false, limit);
        }
    };
}

// Exportar fun√ß√µes para debug
window.debugApp = {
    uiManager: () => uiManager,
    apiManager: () => apiManager,
    chartsManager: () => chartsManager,
    saveFormData,
    loadFormData,
    updateCharts,
    applyTheme
};

console.log('üìä ML Cancer Detection App carregada!');
console.log('üîß Use window.debugApp para debug');